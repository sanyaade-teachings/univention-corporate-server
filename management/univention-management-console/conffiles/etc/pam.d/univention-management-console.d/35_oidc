@!@
import json
with open('/usr/share/univention-management-console/oidc/oidc.json') as fd:
	oidc_config = json.load(fd)
default_op = [oidc_config['oidc_default_op']]

openid_provider = [oidc_config['oidc'][rp]['issuer'] for rp in default_op]
jwks = glob.glob('/usr/share/univention-management-console/oidc/*.jwks')

relying_parties = [server for key, server in configRegistry.items() if key.startswith('umc/oidc/trusted/rp/')]
if openid_provider:
	args = []
	for i, jwk in enumerate(jwks):
		args.append('trusted_jwks%d=%s' % (i, jwk))
	for i, op in enumerate(openid_provider):
		args.append('trusted_iss%d=%s' % (i, op))
	for i, rp in enumerate(relying_parties):
		args.append('trusted_rp%d=%s' % (i, rp))
	grace = configRegistry.get_int('umc/oidc/grace_time', 600)
	print('auth sufficient pam_oidc.so grace=%d userid=preferred_username %s' % (grace, ' '.join(args),))
@!@
