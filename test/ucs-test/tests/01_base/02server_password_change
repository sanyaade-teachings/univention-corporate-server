#!/usr/share/ucs-test/runner bash
# shellcheck shell=bash
## desc: Change the server password
## roles-not: [basesystem]
## tags:
##  - SKIP-UCSSCHOOL
##  - basic
##  - apptest
## exposure: dangerous
## join: true

# shellcheck source=../../lib/base.sh
. "$TESTLIBPATH/base.sh" || exit 137
# shellcheck source=../../lib/ucr.sh
. "$TESTLIBPATH/ucr.sh" || exit 137

RETVAL=100
read -r old_pw </etc/machine.secret

ucr set server/password/interval=0

/usr/lib/univention-server/server_password_change || fail_test 110 "server_password_change failed"

ucr_restore

read -r new_pw </etc/machine.secret
[ "$new_pw" = "$old_pw" ] &&
	fail_test 110 "machine.secret unchanged after server_password_change"

wait_for_replication

/usr/share/univention-join/check_join_status || fail_test 110 "check_join_status failed"

exit "${RETVAL:-0}"
