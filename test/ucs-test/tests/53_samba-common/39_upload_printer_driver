#!/usr/share/ucs-test/runner bash
# shellcheck shell=bash
## desc: "Upload printer driver via rpcclient"
## exposure: dangerous
## packages:
##  - univention-samba | univention-samba4
## bugs: [55048, 55940]
## roles:
## - domaincontroller_master
## - domaincontroller_backup
## - domaincontroller_slave
## - memberserver

# shellcheck source=../../lib/base.sh
. "$TESTLIBPATH/base.sh" || exit 137

admin="$(echo "${tests_domainadmin_account:?}" | sed -e 's|uid=||;s|,.*||')%${tests_domainadmin_pwd:?}"

declare -a files_to_remove
declare -a drivers_to_remove
driver_dir='/var/lib/samba/drivers/x64'

cleanup () {
	for driver in "${drivers_to_remove[@]}"; do
		rpcclient -U "$admin" localhost -c "deldriverex $driver" || :
	done
	for file in "${files_to_remove[@]}"; do
		rm -f "$driver_dir/3/$file"
		rm -f "$driver_dir/$file"
	done
}
trap cleanup INT TERM EXIT

cleanup

_add () {  # <suffix> [<direct-path>]
	local dst="${2:-${driver_name:?}-${1:?}}"
	[ -n "${2:-}" ] ||
		smbclient "//$(hostname)/print\$" -U "$admin" -c "put /etc/hostname x64/${dst}" ||
		fail_fast 1 "smbclient failed"
	files_to_remove+=("$dst")
	settings+=("$dst")
}

upload_printer_driver () {
	local driver="${1##*/}"
	driver_name="test-driver-$(makepasswd)"
	declare -a settings=("$driver_name")
	_add driver "$driver"
	_add data
	_add config
	_add help
	_add lang-mon
	settings+=(RAW '')
	local IFS=':'
	rpcclient \
		-U "$admin" localhost \
		-c "adddriver 'Windows x64' '${settings[*]}'" || fail_fast 1 "adddriver failed"
	drivers_to_remove+=("$driver_name")
}

upload_printer_driver ''

# check uploaded driver
rpcclient -U "$admin" localhost -c "enumdrivers 3"
rpcclient -U "$admin" localhost -c "enumdrivers 3" |
	grep -F "Driver Name: [$driver_name]" ||
	fail_fast 1 "could not find new driver in enumdrivers"

exit "${RETVAL:-0}"
