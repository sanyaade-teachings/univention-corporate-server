#!/usr/share/ucs-test/runner bash
# shellcheck shell=bash
## desc: "Creating a shared printer and printing from smbclient and lp with special characters in printer name"
## exposure: dangerous
## packages:
##  - univention-samba | univention-samba4
##  - univention-printserver
##  - netcat-openbsd
## roles:
## - domaincontroller_master
## - domaincontroller_backup
## - domaincontroller_slave
## - memberserver

# shellcheck source=../../lib/base.sh
. "$TESTLIBPATH/base.sh" || exit 137
# shellcheck source=../../lib/user.sh
. "$TESTLIBPATH/user.sh" || exit 137
# shellcheck source=../../lib/random.sh
. "$TESTLIBPATH/random.sh" || exit 137
# shellcheck source=../../lib/ucr.sh
. "$TESTLIBPATH/ucr.sh" || exit 137
# shellcheck source=../../lib/undo.sh
. "$TESTLIBPATH/undo.sh" || exit 137

#create user
echo "----Create user"
SAMBA="true"
MAIL="false"
KERBEROS="true"
PERSON="false"
POSIX="true"

username="$(user_randomname)"
#printername="$(random_chars 5)"'"'"$(random_chars 5)"  # lp fails with " in the name (Permission denied)
printername="$(random_chars 10)"
#sambaprintername="$(random_chars 12)"'" '"$(random_chars 46)"
sambaprintername="$(random_chars 12) $(random_chars 46)"
password=univention

printsharebasedn="cn=shares,$ldap_base"
printerdn="cn=$printername,$printsharebasedn"

undo wait_for_replication_and_postrun

tmp="$(mktemp-d )"
undo rm -rf "$tmp"

ucr set directory/manager/web/modules/shares/printer/properties/name/syntax=string directory/manager/web/modules/shares/printer/properties/sambaName/syntax=string
undo ucr_restore
user_create "$username" || fail_fast 1 "Could not create user $username."
undo user_remove "$username"

#create printer
echo "----create printer"
printercreated="$(udm-test shares/printer create \
	--position "$printsharebasedn" \
	--set "name=$printername" \
	--set "sambaName=$sambaprintername" \
	--set "spoolHost=$hostname.$domainname" \
	--set "uri=socket:// 127.0.0.1:12346" \
	--set "model=None")" || fail_fast 1 "Could not create printer: $printercreated"
printerdn="$(UDM1 <<<"$printercreated")"
undo udm-test shares/printer remove --dn="$printerdn"

wait_for_replication_and_postrun

## look for printer and user
echo "----Testing wether printer share '$sambaprintername' and user '$username' have been created"
# shellcheck disable=SC2317
check_share () { output="$(smbclient "//localhost/$sambaprintername" -U "$username%$password" -c "exit" 2>&1)"; }
retry 20 check_share ||
	case "$output" in
		*NT_STATUS_ACCESS_DENIED*) fail_fast 1 "User was not provided 20 seconds after creation" ;;
		*) fail_fast 1 "Samba did not provide the printer share 20 seconds after creation" ;;
	esac

uname -a >"$tmp/filename"


section CUPS

#create output socket
nc -l 12346 > "$tmp/$printername" &
nc_pid=$!
undo kill -9 "$nc_pid"

## initiate print
echo "initiate print"
retry 20 lp -d "$printername" -U "$username" "$tmp/filename" ||
		fail_fast 1 "CUPS: Initiate printing has not been successful."

## check output
echo "check output"
retry 20 grep -F -f "$tmp/filename" "$tmp/$printername" ||
		fail_fast 1 "CUPS: Nothing has been printed to the output file."

kill -9 "$nc_pid" >/dev/null 2>&1


section Samba

#create output socket
nc -l 12346 > "$tmp/$sambaprintername" &
nc_pid=$!
undo kill -9 "$nc_pid"

## initiate print
echo "initiate print"
## Important: Wait.. Otherwise, if ONE too early attempt fails, then it seems to get cached for about 5 min.
sleep 10
retry_delay=300 retry 3 smbclient -U"$username%$password" "//$hostname.$domainname/$sambaprintername" -c "print \"$tmp/filename\"" ||
	fail_fast 1 "SAMBA: Initiate printing has not been successful."

## check output
echo "check output"
retry 20 grep -q "$(uname -a)" "$tmp/$sambaprintername" ||
	fail_fast 1 "SAMBA: Nothing has been printed to the output file."

exit "${RETVAL:-0}"
