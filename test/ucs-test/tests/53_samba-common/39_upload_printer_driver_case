#!/usr/share/ucs-test/runner bash
# shellcheck shell=bash
## desc: "Upload printer driver files with different case"
## exposure: dangerous
## packages:
##  - univention-samba | univention-samba4
## bugs: [52051, 55940]
## roles:
## - domaincontroller_master
## - domaincontroller_backup
## - domaincontroller_slave
## - memberserver

# shellcheck source=../../lib/base.sh
. "$TESTLIBPATH/base.sh" || exit 137

admin="$(echo "${tests_domainadmin_account:?}" | sed -e 's|uid=||;s|,.*||')%${tests_domainadmin_pwd:?}"

declare -a files_to_remove
declare -a drivers_to_remove
driver_dir='/var/lib/samba/drivers/x64'

cleanup () {
	for driver in "${drivers_to_remove[@]}"; do
		rpcclient -U "$admin" localhost -c "deldriverex $driver" || :
	done
	for file in "${files_to_remove[@]}"; do
		rm -f "$driver_dir/3/$file"
		rm -f "$driver_dir/$file"
	done
}
trap cleanup INT TERM EXIT

cleanup

_add () {  # <suffix> [<direct-path>]
	local dst="${2:-${driver_name:?}-${1:?}}"
	[ -n "${2:-}" ] ||
		smbclient "//$(hostname)/print\$" -U "$admin" -c "put /etc/hostname x64/${dst}" ||
		fail_fast 1 "smbclient failed"
	files_to_remove+=("$dst")
	settings+=("$dst")
}

upload_printer_driver () {
	local driver="${1##*/}"
	driver_name="test-driver-$(makepasswd)"
	declare -a settings=("$driver_name")
	_add driver "$driver"
	_add data
	_add config
	_add help
	: _add lang-mon
	settings+=('' RAW '')
	local IFS=':'
	rpcclient \
		-U "$admin" localhost \
		-c "adddriver 'Windows x64' '${settings[*]}'" || fail_fast 1 "adddriver failed"
	drivers_to_remove+=("$driver_name")
}

check_driver_file () {
	local driver_file="$1" md5sum="$2" md5sum_new
	md5sum_new="$(md5sum <"$driver_dir/3/$driver_file")"
	[ "$md5sum_new" = "$md5sum" ]
}

# this should work
FN="$driver_dir/MOIN.DLL"
echo "version1" >"$FN"
chown "${admin%%%*}" "$FN"
md5sum_1="$(md5sum <"$FN")"
upload_printer_driver "$FN"
check_driver_file MOIN.DLL "$md5sum_1" || fail_fast 1 "driver file checksum mismatch in download area"
rm -f "$FN"

# check that this file is not uploaded
FN="$driver_dir/moin.dll"
echo "version2" >"$FN"
chown "${admin%%%*}" "$FN"
touch -a -m -d "-20days" "$FN"
upload_printer_driver "$FN"
check_driver_file MOIN.DLL "$md5sum_1" || fail_fast 1 "driver file checksum mismatch in download area, driver overwritten?"
test -e "$driver_dir/3/moin.dll" && fail_fast 1 "driver file exist but shouldn't"
rm -f "$FN"

# check that this file is upload (modify time is older than the first file)
# and MOIN.DLL is overwritten
FN="$driver_dir/moin.dll"
echo "version3" >"$FN"
chown "${admin%%%*}" "$FN"
touch -a -m -d "+10days" "$FN"
md5sum_3="$(md5sum <"$FN")"
upload_printer_driver "$FN"
check_driver_file MOIN.DLL "$md5sum_3" || fail_fast 1 "driver not overwritten, but should be"
test -e "$driver_dir/3/moin.dll" && fail_fast 1 "driver file exists, but shouldn't"
rm -f "$FN"

# and again
FN="$driver_dir/moin.DLL"
echo "version4" >"$FN"
chown "${admin%%%*}" "$FN"
touch -a -m -d "+20days" "$FN"
md5sum_4="$(md5sum <"$FN")"
upload_printer_driver "$FN"
check_driver_file MOIN.DLL "$md5sum_4" || fail_fast 1 "driver not overwritten, but should be"
test -e "$driver_dir/3/moin.DLL" && fail_fast 1 "driver file exists, but shouldn't"
test -e "$driver_dir/3/moin.dll" && fail_fast 1 "driver file exists, but shouldn't"
rm -f "$FN"

exit "${RETVAL:-0}"
